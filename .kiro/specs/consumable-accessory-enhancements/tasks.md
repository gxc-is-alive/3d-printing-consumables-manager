# 实现计划：耗材和配件功能增强

## 概述

本实现计划将功能增强分为三个主要部分：数据库迁移、后端服务实现、前端 UI 实现。采用增量开发方式，确保每个步骤都可以独立验证。

## 任务

- [x] 1. 数据库模型更新

  - [x] 1.1 创建 Prisma 迁移：为 Accessory 表添加 usageType 和 inUseStartedAt 字段
    - 添加 `usageType String @default("consumable")` 字段
    - 添加 `inUseStartedAt DateTime?` 字段
    - 为 AccessoryUsage 表添加 `duration Int?` 字段
    - _需求: 3.1_
  - [x] 1.2 运行迁移并验证数据库结构
    - _需求: 3.1_

- [x] 2. 后端服务实现 - 批量创建耗材

  - [x] 2.1 在 ConsumableService 中实现 batchCreate 方法
    - 使用 Prisma 事务确保原子性
    - 支持 quantity、isOpened、openedAt 参数
    - 验证输入参数
    - _需求: 1.1, 1.2, 1.3, 1.4, 2.3, 2.4, 2.5_
  - [x] 2.2 编写批量创建属性测试
    - **属性 1: 批量创建数量一致性**
    - **属性 2: 批量创建属性共享**
    - **属性 3: 批量创建事务原子性**
    - **验证: 需求 1.1, 1.2, 1.3, 1.4**
  - [x] 2.3 编写开封状态属性测试
    - **属性 4: 开封状态默认值**
    - **属性 5: 批量创建开封状态一致性**
    - **验证: 需求 2.3, 2.4, 2.5**
  - [x] 2.4 添加批量创建 API 路由
    - POST /api/consumables/batch
    - _需求: 1.1, 1.5_

- [x] 3. 检查点 - 批量创建功能验证

  - 确保所有测试通过，如有问题请询问用户

- [x] 4. 后端服务实现 - 配件使用类型

  - [x] 4.1 更新 AccessoryService 创建方法支持 usageType
    - 添加 usageType 参数，默认值为 'consumable'
    - 更新状态计算逻辑
    - _需求: 3.1, 3.2_
  - [x] 4.2 实现 startUsing 方法
    - 验证配件为耐用型
    - 更新状态为 'in_use'
    - 记录 inUseStartedAt
    - _需求: 4.2_
  - [x] 4.3 实现 stopUsing 方法
    - 验证配件当前为 'in_use' 状态
    - 恢复状态为 'available'
    - 创建使用记录（包含 duration）
    - _需求: 4.4_
  - [x] 4.4 更新 delete 方法添加使用中保护
    - 检查状态是否为 'in_use'
    - 如果是则拒绝删除
    - _需求: 4.6_
  - [x] 4.5 编写配件使用类型属性测试
    - **属性 6: 配件使用类型有效性**
    - **属性 7: 耐用型配件状态转换**
    - **属性 8: 消耗型配件数量递减**
    - **属性 9: 使用中配件删除保护**
    - **验证: 需求 3.1, 3.3, 3.4, 4.2, 4.4, 4.6**
  - [x] 4.6 添加配件使用状态 API 路由
    - POST /api/accessories/:id/start-using
    - POST /api/accessories/:id/stop-using
    - _需求: 4.2, 4.4_

- [x] 5. 检查点 - 配件使用类型功能验证

  - 确保所有测试通过，如有问题请询问用户

- [x] 6. 前端实现 - 耗材批量添加

  - [x] 6.1 更新 consumable store 添加批量创建方法
    - 添加 batchCreateConsumable 方法
    - 处理 API 响应
    - _需求: 1.1, 1.5_
  - [x] 6.2 更新 ConsumablesView 表单
    - 添加数量输入框
    - 添加开封状态选择
    - 添加开封日期输入（条件显示）
    - _需求: 1.5, 2.1, 2.2_

- [x] 7. 前端实现 - 配件使用类型

  - [x] 7.1 更新 accessory store
    - 添加 startUsing 和 stopUsing 方法
    - 更新 ACCESSORY_STATUS 常量
    - _需求: 4.2, 4.4, 5.1, 5.2_
  - [x] 7.2 更新 AccessoriesView 表单
    - 添加使用类型选择
    - _需求: 3.2_
  - [x] 7.3 更新 AccessoriesView 配件卡片
    - 根据使用类型显示不同操作按钮
    - 耐用型显示"开始使用"/"结束使用"按钮
    - 显示使用中状态和开始时间
    - 添加蓝色状态标识
    - _需求: 4.1, 4.3, 4.5, 5.1, 5.2, 5.3_
  - [x] 7.4 更新筛选功能支持 in_use 状态
    - _需求: 5.4_

- [x] 8. 最终检查点 - 完整功能验证
  - 确保所有测试通过，如有问题请询问用户

## 备注

- 所有任务都是必须完成的，包括属性测试
- 每个任务都引用了具体的需求以便追溯
- 检查点用于确保增量验证
- 属性测试验证通用正确性属性
